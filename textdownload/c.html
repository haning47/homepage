<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“¥ æ‰¹æ¬¡ä¸‹è¼‰æ¾å±±é«˜ä¸­ç¶²ç«™æª”æ¡ˆ</title>
<style>
body {
  font-family: "Noto Sans TC", sans-serif;
  background-color: #f4f4f4;
  color: #333;
  padding: 30px;
  text-align: center;
}
input, button {
  padding: 10px 16px;
  font-size: 16px;
  margin: 5px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}
button {
  background-color: #0a5c44;
  color: white;
  transition: background 0.2s;
}
button:hover {
  background-color: #0c7357;
}
#log {
  margin-top: 20px;
  text-align: left;
  max-width: 700px;
  margin-left: auto;
  margin-right: auto;
  background: #fff;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
a.download-link {
  display: block;
  margin: 6px 0;
  text-decoration: none;
  color: #0a5c44;
}
a.download-link:hover {
  text-decoration: underline;
}
</style>
</head>
<body>
<h2>ğŸ“¥ æ‰¹æ¬¡ä¸‹è¼‰æ¾å±±é«˜ä¸­ç¶²ç«™æª”æ¡ˆ</h2>
<p>è¼¸å…¥è¦æŠ“å–çš„æ¾å±±é«˜ä¸­ç¶²é ç¶²å€ï¼ˆä¾‹å¦‚ï¼š<code>https://www.sssh.tp.edu.tw/</code>ï¼‰</p>

<input type="text" id="urlInput" placeholder="è¼¸å…¥ç¶²å€..." size="50">
<button id="fetchBtn">æŠ“å–é€£çµ</button>
<button id="downloadAllBtn" disabled>å…¨éƒ¨ä¸‹è¼‰</button>

<div id="log"></div>

<script>
let foundLinks = [];

document.getElementById("fetchBtn").addEventListener("click", async () => {
  const url = document.getElementById("urlInput").value.trim();
  const log = document.getElementById("log");
  const downloadAllBtn = document.getElementById("downloadAllBtn");
  foundLinks = [];
  downloadAllBtn.disabled = true;
  log.innerHTML = "";

  if (!url) {
    log.innerHTML = "âš ï¸ è«‹è¼¸å…¥ç¶²å€";
    return;
  }

  log.innerHTML = "â³ æ­£åœ¨æŠ“å–é é¢...";

  try {
    // ä½¿ç”¨ allorigins ä»£ç†ä»¥ç¹é CORS
    const api = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
    const response = await fetch(api);
    if (!response.ok) throw new Error("ä»£ç†ä¼ºæœå™¨è®€å–å¤±æ•—");
    const data = await response.json();
    const text = data.contents;

    const parser = new DOMParser();
    const doc = parser.parseFromString(text, "text/html");
    const links = doc.querySelectorAll("a[href]");
    log.innerHTML = "";

    const targetPrefix = "https://www.sssh.tp.edu.tw";
    let count = 0;

    links.forEach(link => {
      const href = link.getAttribute("href");
      const text = (link.textContent || "æœªå‘½å").trim();
      if (!href || href.startsWith("#")) return;

      // è§£ææˆçµ•å°ç¶²å€
      const absUrl = new URL(href, url).href;

      // âœ… åƒ…ä¿ç•™é–‹é ­æ˜¯æŒ‡å®šç¶²åŸŸçš„é€£çµ
      if (!absUrl.startsWith(targetPrefix)) return;

      const parts = absUrl.split(".");
      const ext = parts.length > 1 ? "." + parts.pop() : "";
      const safeName = text.replace(/[\\\/:*?"<>|]/g, "_") + ext;

      foundLinks.push({ name: safeName, url: absUrl });
      count++;

      const a = document.createElement("a");
      a.href = absUrl;
      a.download = safeName;
      a.textContent = `ä¸‹è¼‰ï¼š${safeName}`;
      a.className = "download-link";
      a.target = "_blank";
      log.appendChild(a);
    });

    if (count === 0) {
      log.innerHTML = "âš ï¸ æ‰¾ä¸åˆ°ä»»ä½•ç¬¦åˆæ¢ä»¶çš„é€£çµï¼ˆåƒ…é™ https://www.sssh.tp.edu.tw é–‹é ­ï¼‰";
      return;
    }

    downloadAllBtn.disabled = false;
    log.insertAdjacentHTML("afterbegin", `<h3>âœ… æ‰¾åˆ° ${count} å€‹å¯ä¸‹è¼‰æª”æ¡ˆï¼š</h3>`);

  } catch (err) {
    log.innerHTML = `âŒ éŒ¯èª¤ï¼š${err.message}`;
  }
});

document.getElementById("downloadAllBtn").addEventListener("click", () => {
  if (foundLinks.length === 0) return;
  let delay = 0;
  foundLinks.forEach((file, index) => {
    setTimeout(() => {
      const a = document.createElement("a");
      a.href = file.url;
      a.download = file.name;
      a.click();
    }, delay);
    delay += 700; // æ¯æ¬¡ä¸‹è¼‰é–“éš” 0.7 ç§’ï¼Œé¿å…ç€è¦½å™¨é˜»æ“‹
  });
});
</script>
</body>
</html>
