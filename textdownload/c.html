<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>æ‰¹æ¬¡ä¸‹è¼‰ï¼ˆæ¾å±±é«˜ä¸­ - é™ sssh.tp.edu.twï¼‰</title>
<style>
body{font-family:"Noto Sans TC",sans-serif;background:#f4f4f4;color:#333;padding:24px;text-align:center}
input,button{padding:10px 14px;font-size:16px;margin:6px;border-radius:6px;border:0;cursor:pointer}
button{background:#0a5c44;color:#fff}
#log{max-width:900px;margin:18px auto;text-align:left;background:#fff;padding:18px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.06)}
a.download-link{display:block;margin:6px 0;color:#0a5c44;text-decoration:none}
</style>
</head>
<body>
<h2>ğŸ“¥ æ‰¹æ¬¡ä¸‹è¼‰ï¼ˆåƒ… https://www.sssh.tp.edu.twï¼‰</h2>
<p>è¼¸å…¥è¦æŠ“å–çš„æ¾å±±é«˜ä¸­ç¶²é ç¶²å€ï¼ˆä¾‹å¦‚ï¼šhttps://www.sssh.tp.edu.tw/... ï¼‰</p>
<input id="urlInput" placeholder="è¼¸å…¥ç¶²å€..." size="60" />
<button id="fetchBtn">æŠ“å–é€£çµ</button>
<button id="downloadAllBtn" disabled>å…¨éƒ¨ä¸‹è¼‰</button>
<div id="log"></div>

<script>
/*
 æ”¹è‰¯é‚è¼¯ï¼š
 1) æœƒä¾åºå˜—è©¦å¤šå€‹å…¬é–‹ CORS ä»£ç†ï¼ˆè‹¥å…¶ä¸­ä¸€å€‹æˆåŠŸå‰‡åœæ­¢ï¼‰
 2) ä»æœƒåƒ…ä¿ç•™ä»¥ https://www.sssh.tp.edu.tw é–‹é ­çš„é€£çµ
 3) è‹¥å…¨éƒ¨ä»£ç†éƒ½å¤±æ•—ï¼Œæœƒé¡¯ç¤ºå¯èƒ½åŸå› èˆ‡å»ºè­°
 æ³¨æ„ï¼šå…¬å…±ä»£ç†ä¸¦éç™¾åˆ†ä¹‹ç™¾å¯é ï¼›æœ€ç©©çš„æ–¹æ³•æ˜¯è‡ªå»º proxyï¼ˆä»¥ä¸‹å›æ‡‰æœ‰ç¯„ä¾‹ï¼‰
*/
const proxies = [
  (u)=>`https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`, // å–å¾— raw å…§å®¹
  (u)=>`https://api.allorigins.win/get?url=${encodeURIComponent(u)}`, // å›å‚³ json.contentsï¼ˆå‚™æ´ï¼‰
  (u)=>`https://thingproxy.freeboard.io/fetch/${encodeURIComponent(u)}` // å‚™æ´ä»£ç†
];

let foundLinks = [];

function log(msg, isHtml=false){
  const el = document.getElementById('log');
  if(isHtml) el.innerHTML = msg;
  else el.innerText = msg;
}

async function fetchViaProxy(url){
  // ä¾åºå˜—è©¦ proxiesï¼›å›å‚³ text æˆ– throw
  for(const p of proxies){
    const api = p(url);
    try{
      const r = await fetch(api);
      if(!r.ok) throw new Error(`proxy ${api} å›å‚³ ${r.status}`);
      // allorigins.raw æœƒç›´æ¥å›å‚³ textï¼› allorigins.get å›å‚³ json
      const ct = r.headers.get('content-type') || '';
      if(ct.includes('application/json') || api.includes('/get?')) {
        const j = await r.json();
        // allorigins get å›å‚³ {contents: "..."}ï¼Œthingproxy ä¹Ÿå¯èƒ½å› json
        if(j && j.contents) return j.contents;
        // è‹¥ json ä½†æ²’æœ‰ contentsï¼Œå˜—è©¦è½‰ç‚º string
        return JSON.stringify(j);
      } else {
        // ç›´æ¥å› text
        return await r.text();
      }
    }catch(e){
      // å˜—è©¦ä¸‹ä¸€å€‹ proxyï¼ˆè¨˜éŒ„ä½†ä¸ç«‹å³æ‹‹éŒ¯ï¼‰
      console.warn('proxy failed', p(url), e.message);
      continue;
    }
  }
  throw new Error('æ‰€æœ‰å…¬é–‹ä»£ç†çš†å¤±æ•—ï¼ˆå¯èƒ½è¢«å°é–æˆ–ç›®æ¨™éœ€é©—è­‰ / ç‚ºéå…¬é–‹å…§å®¹ï¼‰');
}

document.getElementById('fetchBtn').addEventListener('click', async ()=>{
  const url = document.getElementById('urlInput').value.trim();
  const downloadAllBtn = document.getElementById('downloadAllBtn');
  foundLinks = [];
  downloadAllBtn.disabled = true;
  if(!url){ log('âš ï¸ è«‹è¼¸å…¥ç¶²å€'); return; }
  log('â³ æ­£åœ¨é€éä»£ç†æŠ“å–é é¢ï¼Œè‹¥å¤±æ•—æœƒé¡¯ç¤ºåŸå› ï¼ˆè«‹è€å¿ƒç­‰å€™ï¼‰...', true);

  try{
    // æœ‰å¯èƒ½ target ç‚º http è€Œä½ çš„é é¢æ˜¯ httpsï¼ˆæœƒè¢«ç€è¦½å™¨é å…ˆé˜»æ“‹ï¼‰â€” æé†’æª¢æŸ¥
    if(url.startsWith('http:') && location.protocol === 'https:'){
      log('â— æ³¨æ„ï¼šä½ çš„ GitHub Pages ç‚º HTTPSï¼Œä½†ç›®æ¨™ç‚º HTTPï¼ˆç€è¦½å™¨å¯èƒ½æœƒé˜»æ“‹ mixed contentï¼‰ã€‚è«‹æ”¹ç”¨ http æ–¼æœ¬æ©Ÿæ¸¬è©¦æˆ–æ¶ proxyã€‚', true);
    }

    const text = await fetchViaProxy(url);
    // è‹¥ allorigins.get å›å‚³ JSON å­—ä¸²ï¼Œä¸Šé¢æœƒè½‰æˆ JSON string â€” å˜—è©¦ parse ç‚º html text
    const parser = new DOMParser();
    const doc = parser.parseFromString(text, 'text/html');
    const links = doc.querySelectorAll('a[href]');
    const targetPrefix = 'https://www.sssh.tp.edu.tw';
    let count = 0;
    const logContainer = document.createElement('div');

    links.forEach(link=>{
      const href = link.getAttribute('href');
      const label = (link.textContent || 'æœªå‘½å').trim();
      if(!href || href.startsWith('#')) return;
      const absUrl = new URL(href, url).href;
      if(!absUrl.startsWith(targetPrefix)) return;
      // å–å‰¯æª”åï¼ˆå¾ URL pathï¼‰
      const pathname = (new URL(absUrl)).pathname;
      const idx = pathname.lastIndexOf('.');
      const ext = (idx>-1) ? pathname.slice(idx) : '';
      const safeName = label.replace(/[\\\/:*?"<>|]/g,'_') + ext;
      foundLinks.push({name: safeName, url: absUrl});
      const a = document.createElement('a');
      a.href = absUrl; a.download = safeName; a.target='_blank';
      a.className = 'download-link';
      a.textContent = `ä¸‹è¼‰ï¼š${safeName} â†’ ${absUrl}`;
      logContainer.appendChild(a);
      count++;
    });

    if(count===0){
      log('âš ï¸ æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„é€£çµï¼ˆåƒ…é™ https://www.sssh.tp.edu.tw é–‹é ­ï¼‰ã€‚', true);
      return;
    }
    document.getElementById('log').innerHTML = `<h3>âœ… æ‰¾åˆ° ${count} å€‹å¯ä¸‹è¼‰æª”æ¡ˆï¼š</h3>`;
    document.getElementById('log').appendChild(logContainer);
    downloadAllBtn.disabled = false;

  }catch(err){
    // è‹¥ fetchViaProxy æ‹‹éŒ¯ï¼Œé¡¯ç¤ºè©³ç´°èªªæ˜ï¼ˆå«å»ºè­°ï¼‰
    const msg = `âŒ éŒ¯èª¤ï¼š${err.message}\n\nå¯èƒ½åŸå› ï¼š\n` +
      `1) ç›®æ¨™ç¶²ç«™éœ€ç™»å…¥æˆ–æœ‰é˜²çˆ¬æ©Ÿåˆ¶ï¼ˆå…¬å…±ä»£ç†ç„¡æ³•é€šéï¼‰ã€‚\n` +
      `2) ç›®æ¨™æˆ–ä»£ç†è¢«å°é–æˆ–ç›®å‰ç•¶æ©Ÿã€‚\n` +
      `3) ä½ çš„é é¢ç‚º HTTPSï¼Œä½†ç›®æ¨™æ˜¯ HTTPï¼ˆmixed content æœƒè¢«é˜»æ“‹ï¼‰ã€‚\n\nå»ºè­°ï¼š\n` +
      `â€¢ è‹¥å¯ï¼Œæ”¹ç”¨ã€Œè‡ªå»º proxyã€ï¼ˆCloudflare Worker æˆ–å°å‹ Node ä¼ºæœå™¨ï¼‰ã€‚\n` +
      `â€¢ æˆ–åœ¨æœ¬æ©Ÿè‡¨æ™‚ä»¥ç€è¦½å™¨é—œé–‰ CORS æ¸¬è©¦ï¼ˆåƒ…é–‹ç™¼ç”¨ï¼‰ã€‚\n` +
      `â€¢ æˆ‘å¯æä¾›è‡ªå»º proxy çš„ç¨‹å¼ç¯„ä¾‹ï¼ˆCloudflare Worker èˆ‡ Nodeï¼‰ã€‚`;
    document.getElementById('log').innerText = msg;
    console.error(err);
  }
});

document.getElementById('downloadAllBtn').addEventListener('click', ()=>{
  if(foundLinks.length===0) return;
  let delay = 0;
  foundLinks.forEach(f=>{
    setTimeout(()=>{
      const a = document.createElement('a');
      a.href = f.url;
      a.download = f.name;
      a.click();
    }, delay);
    delay += 700;
  });
});
</script>
</body>
</html>
