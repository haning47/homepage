import requests
from bs4 import BeautifulSoup
from urllib.parse import urljoin
from google.colab import files
import time
import os
import re

# -----------------
# 1. è®“ä½¿ç”¨è€…è¼¸å…¥ç›®æ¨™ç¶²å€
# -----------------
print("----------------------------------------")
print("æ­¡è¿ä½¿ç”¨æª”æ¡ˆä¸‹è¼‰å·¥å…·ï¼")
print("----------------------------------------")

# ä½¿ç”¨ input() è®“ä½¿ç”¨è€…åœ¨ Colab å„²å­˜æ ¼ä¸‹æ–¹è¼¸å…¥ç¶²å€
base_url = input("è«‹è¼¸å…¥æ‚¨æƒ³è¦ä¸‹è¼‰æª”æ¡ˆçš„ç¶²é å®Œæ•´ URL (ç¶²å€)ï¼š")

if not base_url:
    print("éŒ¯èª¤ï¼šæœªè¼¸å…¥ç¶²å€ã€‚ç¨‹å¼çµ‚æ­¢ã€‚")
    exit()

# ç¢ºä¿ç¶²å€æ ¼å¼æ­£ç¢º
if not base_url.startswith('http'):
    base_url = 'https://' + base_url

# å®šç¾©è¦ä¸‹è¼‰çš„å¸¸è¦‹æª”æ¡ˆå‰¯æª”å
FILE_EXTENSIONS = ['.pdf', '.doc', '.docx', '.xls', '.xlsx', '.zip', '.rar', '.7z']

# å„²å­˜ (æª”å, é€£çµ) çš„å­—å…¸
download_items = {} 

print(f"é–‹å§‹æƒæç¶²é ï¼š{base_url}")

# -----------------
# 2. çˆ¬å–ç¶²é å…§å®¹ä¸¦è§£æé€£çµå’Œæ–‡å­—
# -----------------
try:
    # è¨­ç½®æ¨™é ­æ¨¡æ“¬ç€è¦½å™¨
    headers = {'User-Agent': 'Mozilla/5.0'}
    response = requests.get(base_url, headers=headers, timeout=15)
    response.raise_for_status() # æª¢æŸ¥ HTTP è«‹æ±‚æ˜¯å¦æˆåŠŸ
except requests.exceptions.RequestException as e:
    print(f"ç„¡æ³•å–å¾—ç¶²é å…§å®¹ï¼Œè«‹æª¢æŸ¥ç¶²å€æˆ–ç¶²è·¯é€£ç·šã€‚éŒ¯èª¤ï¼š{e}")
    exit()

soup = BeautifulSoup(response.text, 'html.parser')

# å°‹æ‰¾æ‰€æœ‰è¶…é€£çµ
all_links = soup.find_all('a', href=True)

# å®šç¾©ä¸€å€‹å‡½æ•¸ä¾†æ¸…ç†æª”åï¼Œç§»é™¤éæ³•å­—å…ƒ
def sanitize_filename(text):
    # ç§»é™¤ Windows/Linux ä¸å…è¨±çš„å­—å…ƒ
    cleaned = re.sub(r'[\\/:*?"<>|]', '_', text)
    # ç§»é™¤é–‹é ­æˆ–çµå°¾çš„ç©ºç™½
    return cleaned.strip()

for link in all_links:
    href = link['href']
    link_text = link.get_text(strip=True) # ç²å–è¶…é€£çµçš„æ–‡å­—å…§å®¹

    # æª¢æŸ¥é€£çµæ˜¯å¦æŒ‡å‘ç‰¹å®šçš„æª”æ¡ˆé¡å‹
    for ext in FILE_EXTENSIONS:
        if href.lower().endswith(ext):
            absolute_url = urljoin(base_url, href)
            
            # A. å–å¾—å‰¯æª”å
            file_extension = ext
            
            # B. å»ºç«‹æ–°æª”åï¼šæ¸…ç†å¾Œçš„é€£çµæ–‡å­— + å‰¯æª”å
            base_name = sanitize_filename(link_text)
            
            # å¦‚æœé€£çµæ–‡å­—å¤ªçŸ­æˆ–ä¸é©åˆï¼Œå¯ä»¥ä½¿ç”¨ URL ä¸­æå–çš„æª”åä½œç‚ºå‚™ç”¨
            if not base_name or len(base_name) < 3:
                 url_filename = absolute_url.split('/')[-1].split('?')[0]
                 base_name = sanitize_filename(os.path.splitext(url_filename)[0])
                 
            new_filename = f"{base_name}{file_extension}"

            # ç¢ºä¿æª”åæ˜¯å”¯ä¸€çš„ (å¦‚æœæœ‰å¤šå€‹é€£çµæ–‡å­—ç›¸åŒçš„æª”æ¡ˆ)
            count = 1
            final_filename = new_filename
            while final_filename in download_items:
                final_filename = f"{base_name}_{count}{file_extension}"
                count += 1
                
            download_items[final_filename] = absolute_url
            break

# -----------------
# 3. ä¸‹è¼‰æª”æ¡ˆåˆ° Colab ä¸¦å‚³è¼¸åˆ°æœ¬åœ°ç«¯
# -----------------

if not download_items:
    print("åœ¨æ­¤ç¶²é ä¸­æ²’æœ‰æ‰¾åˆ°å¯ä¾›ä¸‹è¼‰çš„å¸¸è¦‹æª”æ¡ˆé€£çµã€‚")
else:
    total_files = len(download_items)
    print(f"----------------------------------------")
    print(f"ç¸½å…±æ‰¾åˆ° {total_files} å€‹æª”æ¡ˆé€£çµï¼Œé–‹å§‹ä¸‹è¼‰...")
    print(f"----------------------------------------")

    for i, (filename, file_url) in enumerate(download_items.items()):
        
        print(f"\n[{i+1}/{total_files}] æª”æ¡ˆåç¨±ï¼š{filename}")
        print(f"   -> åŸå§‹é€£çµï¼š{file_url}")
        
        try:
            # A. ä¸‹è¼‰æª”æ¡ˆåˆ° Colab æš«å­˜ç©ºé–“
            file_response = requests.get(file_url, stream=True, timeout=30, headers=headers)
            file_response.raise_for_status()

            print(f"   -> ä¸‹è¼‰ä¸­... (å¤§å°: {len(file_response.content) / 1024:.2f} KB)")
            with open(filename, 'wb') as f:
                f.write(file_response.content) 

            # B. é€éç€è¦½å™¨å°‡æª”æ¡ˆå‚³è¼¸åˆ°æ‚¨çš„æœ¬åœ°é›»è…¦
            print(f"   -> å‚³è¼¸åˆ°æœ¬åœ°é›»è…¦çš„é è¨­ä¸‹è¼‰è³‡æ–™å¤¾...")
            files.download(filename)
            
            # ç”±æ–¼ç€è¦½å™¨éœ€è¦æ™‚é–“è™•ç†ä¸‹è¼‰ï¼Œå»¶é² 2 ç§’ç¢ºä¿ä¸‹è¼‰æŒ‡ä»¤é€å‡º
            time.sleep(2) 
            
        except Exception as e:
            print(f"   -> ä¸‹è¼‰æˆ–å‚³è¼¸ {filename} æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")

    print("\n========================================")
    print("ğŸ‰ æ‰€æœ‰æª”æ¡ˆä¸‹è¼‰ç¨‹åºå·²ç™¼é€å®Œæˆï¼")
    print("è«‹æª¢æŸ¥æ‚¨çš„ç€è¦½å™¨ä¸‹è¼‰ä½‡åˆ—æˆ–æœ¬åœ°é›»è…¦çš„é è¨­ä¸‹è¼‰è³‡æ–™å¤¾ã€‚")
    print("========================================")